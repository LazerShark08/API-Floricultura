<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Carrinho - Floricultura</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>

<div class="aero-bg"></div>
<div class="lens-flare"></div>
<div class="aero-ambient"></div>

<div class="bubbles">
  <div class="bubble" style="--size:60px; --time:18s; --drift:20px; left:10%;"></div>
  <div class="bubble" style="--size:40px; --time:22s; --drift:-15px; left:25%;"></div>
  <div class="bubble" style="--size:80px; --time:17s; --drift:30px; left:40%;"></div>
  <div class="bubble" style="--size:55px; --time:26s; --drift:-25px; left:60%;"></div>
  <div class="bubble" style="--size:70px; --time:19s; --drift:35px; left:75%;"></div>
</div>

<header class="site-header">
    <div class="brand">
        <div class="logo-gloss"><span>Flori</span><strong>Bloom</strong></div>
        <div class="tag">Flores frescas • Entrega rápida ✿</div>
    </div>

    <nav class="nav">
        <a href="index.html">Home</a>
        <a href="cart.html">Carrinho</a>
        <a href="login.html">Login</a>
    </nav>
</header>

<div class="container">
    <h2>Seu Carrinho</h2>

    <div id="cart-items"></div>

    <div id="cart-total" class="total-box"></div>

    <div class="cart-actions">
        <button class="btn" onclick="comprar()">Finalizar compra</button>
    </div>
</div>

<script>
async function carregarCarrinho(){
    const token = localStorage.getItem("token");
    if(!token){
        alert("Faça login primeiro!");
        return window.location.href = "login.html";
    }

    const resp = await fetch("/cart", {
        headers: {
            "Authorization": "Bearer " + token
        }
    });

    const items = await resp.json();

    let total = 0;

    document.getElementById("cart-items").innerHTML = items.map(item => {
        const price = item.flower.price;
        const subtotal = price * item.quantity;
        total += subtotal;

        return `
            <div class="cart-card">
                <img src="${item.flower.image_url}" class="cart-img">

                <div class="cart-info">
                    <h3>${item.flower.name}</h3>
                    <p>Preço: R$ ${price.toFixed(2)}</p>
                    <p>Quantidade: <strong>${item.quantity}</strong></p>
                    <p>Subtotal: R$ ${subtotal.toFixed(2)}</p>
                </div>

                <button class="remove-btn" onclick="removerItem(${item.id})">
                    Remover
                </button>
            </div>
        `;
    }).join("");

    document.getElementById("cart-total").innerHTML =
        `<h3>Total: R$ ${total.toFixed(2)}</h3>`;
}

async function removerItem(id) {
    const token = localStorage.getItem("token");

    await fetch(`/cart/${id}`, {
        method: "DELETE",
        headers: { "Authorization": "Bearer " + token }
    });

    carregarCarrinho(); // recarregar carrinho
}

async function comprar(){
    const token = localStorage.getItem("token");

    const resp = await fetch("/cart/purchase", {
        method: "POST",
        headers: {
            "Authorization": "Bearer " + token
        }
    });

    if (resp.ok) {
        alert("Compra finalizada!");
        window.location.href = "index.html";
    } else {
        alert("Erro ao finalizar compra.");
    }
}

carregarCarrinho();
</script>

</body>
</html>
